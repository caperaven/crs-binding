const e=Object.getPrototypeOf((async function(){})).constructor;function t(e,t,n){for(let i=t;i<e.length;i++)if(e[i]==n){e.splice(i,1);break}}function n(e){if(-1==e.indexOf("("))return e;const t=[];for(let n of e.split(".")){if(-1!=n.indexOf("("))break;t.push(n)}return t.join(".")}const i=["true","false","-","+","=","<",">","(",")","{","}","/","&","|","=","!","'","`",'"'," ","$",".",",","?",":","null","undefined","new","Math"],s=[".","(",")",","],r=["globals","event","context","parent","data"],l=["$globals","$event","$context","$parent","$data"],a=["'",'"',"`"],o=["'",'"'];function c(e,t,n){return t.length>0&&(e.push(t.join("")),t.length=0),e.push(n),!1}class d{get data(){return crsbinding.data.getValue(this._context)}constructor(e,t,n,i,s,r,l=!0){this._cleanEvents=[],this._globals={},this._element=e,this._context=t,this._property=n,this._value=i,this._ctxName=s||"context",this._eventsToRemove=[],this._isNamedContext="context"!=this._ctxName,this._parentId=r,this._value&&-1!=this._value.indexOf("$parent")&&1==l&&(this._value=this._value.split("$parent.").join(""),this._context=r),this.init&&this.init(),crsbinding.providerManager.register(this),this.initialize().catch(e=>{throw e}),-1!=this._element.nodeName.indexOf("-")&&this._property==this._ctxName&&(this._element[this._property]=this._context)}dispose(){this._eventsToRemove.length=0,this._eventsToRemove=null,this._element=null,this._context=null,this._property=null,this._value=null,this._ctxName=null,this._cleanEvents.forEach(e=>{crsbinding.data.removeCallback(e.context,e.path,e.callback),delete e.context,delete e.path,delete e.callback}),this._cleanEvents=null;for(let e of Object.keys(this._globals))crsbinding.data.removeCallback(crsbinding.$globals,e,this._globals[e]),delete this._globals[e]}async initialize(){}listenOnPath(e,t){const n=1==Array.isArray(e)?e:[e];for(let e of n){let n=this._context;-1!=e.indexOf("$globals.")&&(n=crsbinding.$globals,e=e.split("$globals.").join(""),this._globals[e]=t),this._addCallback(n,e,t)}}_addCallback(e,t,n){crsbinding.data.addCallback(e,t,n),this._cleanEvents.push({context:e,path:t.split("$parent.").join("").split("$context.").join(""),callback:n})}}const h='element.dataset["__property__"] = value == null ? "" : value',_="\nif (element.__classList!=null) {\n    const remove = Array.isArray(element.__classList) ? element.__classList : [element.__classList];\n    remove.forEach(cls => element.classList.remove(cls));\n}",p="\nelement.__classList = value;\nconst add = Array.isArray(value) ? value : [value];\nadd.forEach(cls => element.classList.add(cls));",u=`${_} ${p}`,f=`\n    ${_}\n\n    if (__exp__) {\n        ${p.split("value").join("__true__")}\n    }\n    else {\n        ${p.split("value").join("__false__")}\n    }\n`;class g extends d{dispose(){const e=`${this._ctxName}.`;0==this._value.indexOf(e)&&(this._value=this._value.replace(e,"")),null!=this._expObj&&(crsbinding.expression.release(this._expObj),delete this._expObj),this._exp=null,this._eventHandler=null,super.dispose()}async initialize(){if("$context"==this._value||this._value==this._ctxName)return this.setContext();this._eventHandler=this.propertyChanged.bind(this),this._exp=function(e){let t;if("classlist"==e._property.toLocaleLowerCase())return u;if(-1!=e._property.indexOf("data-")){const t=e._property.replace("data-","");return h.split("__property__").join(t)}return t="value"==e._property||"placeholder"==e._property?'requestAnimationFrame(() => element.__property__ = value == null ? "" : value);':"requestAnimationFrame(() => element.__property__ = value);",e._property=crsbinding.utils.capitalizePropertyPath(e._property),t.split("__property__").join(e._property)}(this),this._expObj=crsbinding.expression.compile(this._exp,["element","value"],{sanitize:!1,ctxName:this._ctxName});let e=this._value;1==this._isNamedContext&&(e=this._value.split(`${this._ctxName}.`).join("")),this.listenOnPath(e,this._eventHandler);const t=crsbinding.data.getValue(this._context,e);null!=t&&this.propertyChanged(e,t)}setContext(){if(null!=this._element&&null!=this._property){const e=()=>{this._element.removeEventListener("ready",e),this._element[this._property]=crsbinding.data.getValue(this._context)};1==this._element.isReady?e():this._element.addEventListener("ready",e)}}propertyChanged(e,t){null!=this._expObj&&(1!=this._isLinked&&null!=this._element._dataId&&(crsbinding.data.link(this._context,e,this._element._dataId,this._property,t),this._isLinked=!0),crsbinding.idleTaskManager.add(this._expObj.function(this.data,this._element,t)))}}const m=["INPUT","SELECT","TEXTAREA"];class x extends g{dispose(){this._element.removeEventListener(this._eventName,this._changeHandler),this._eventName=null,this._changeHandler=null,super.dispose()}async initialize(){await super.initialize(),this._changeHandler=this._change.bind(this),this._eventName=-1!==m.indexOf(this._element.nodeName)?"change":`${this._property}Change`,this._element.addEventListener(this._eventName,this._changeHandler)}_change(e){let t=e.target[this._property];const n=e.target.type||"text",i=`_${n}`;null!=this[i]&&(t=this[i](t,e.target)),crsbinding.data.setProperty(this._context,this._value,t,this._ctxName,"text"==n?"string":n),e.stopPropagation()}_number(e){return Number(e)}_date(e){return new Date(e)}_checkbox(e,t){return 1==t.checked}}function b(e,t){let n=e;if(-1==t.indexOf("."))return n[t];const i=t.split(".");for(let e=0;e<i.length-1;e++){if(n=n[i[e]],null==n)return null}return n[i[i.length-1]]}function v(e,t,n,i,s="context",r){return"context"==s?function(e,t,n,i){y(e,n,crsbinding.data.getValue(t,i))}(e,t,n,i):function(e,t,n,i,s){"context"!=s&&(i=i.split(`${s}.`).join(""));const r=crsbinding.data.getValue(t,i);y(e,n,r)}(e,t,n,i,s),null}function y(e,t,n){if(-1==t.indexOf("data-")){if("value"===(t=crsbinding.utils.capitalizePropertyPath(t))||"placeholder"===t)return;new Function("element","value",`element.${t} = value`)(e,n)}else{const i=t.replace("data-","");e.dataset[i]=n}}class $ extends d{constructor(e,t,n,i,s,r){super(e,t,n,i,s,r),this._eventHandler=this.event.bind(this),this._element.addEventListener(this._property,this._eventHandler)}dispose(){this._element.removeEventListener(this._property,this._eventHandler),this._eventHandler=null,this._fn=null,super.dispose()}async initialize(){let e=`context.${this._value}`.split("$event").join("event");-1==e.indexOf(")")&&(e=`${e}.call(context, event)`),this._fn=new Function("context","event",e)}event(e){const t=crsbinding.data.getContext(this._context);crsbinding.idleTaskManager.add(this._fn(t,e)),e.stopPropagation()}}class O extends d{constructor(e,t,n,i,s,r){super(e,t,n,i,s,r),e.innerText&&-1!=e.innerText.indexOf("$parent.")?(e.innerText=e.innerText.split("$parent.").join(""),this._context=r):e.textContent&&-1!=e.textContent.indexOf("$parent.")&&(e.textContent=e.textContent.split("$parent.").join(""),this._context=r),this._eventHandler=this._change.bind(this),this._expObj=crsbinding.expression.compile(e.innerText||e.textContent,null,{ctxName:this._ctxName});for(let e of this._expObj.parameters.properties)this.listenOnPath(e,this._eventHandler);this._change()}dispose(){crsbinding.expression.release(this._expObj),this._expObj=null,super.dispose(),this._eventHandler=null}_change(){if(null==this._expObj)return;const e=this._element.textContent?"textContent":"innerText";this._element[e]=this._expObj.function(this.data)}}class j extends d{constructor(e,t,n,i,s,r){super(e,t,n,i,s,r),this._eventHandler=this._change.bind(this),this._expObj=crsbinding.expression.compile(this._value,null,{ctxName:this._ctxName});for(let e of this._expObj.parameters.properties)this.listenOnPath(e,this._eventHandler);this._change()}dispose(){crsbinding.expression.release(this._expObj),this._expObj=null,super.dispose(),this._eventHandler=null}_change(){const e=this._expObj.function(this.data);this._element.setAttribute(this._property,e)}}class A extends d{dispose(){this._singular=null,this._plural=null,this._container=null,this._collectionChangedHandler=null,this.positionStruct.addAction=null,this.positionStruct.removeAction=null,this.positionStruct=null,super.dispose()}async initialize(){this._container=this._element.parentElement,this._shouldClearAll=1==this._container.children.length,this._determineInsertParameters();const e=this._value.split("of");this._singular=e[0].trim(),this._plural=e[1].trim(),this._collectionChangedHandler=this._collectionChanged.bind(this),this.listenOnPath(this._plural,this._collectionChangedHandler)}async _collectionChanged(e,t){if(null==t)return this._clear();this._renderItems(t)}_determineInsertParameters(){const e=this._element.nextElementSibling,t=this._element.previousElementSibling;this.positionStruct={startIndex:Array.from(this._container.children).indexOf(this._element),addAction:null!=e?this._insertBefore.bind(e):this._appendItems.bind(this._element),removeAction:()=>this._removeBetween.call(this._element,t,e)}}_appendItems(e){this.parentElement.appendChild(e)}_insertBefore(e){this.parentElement.insertBefore(e,this)}_removeBetween(e,t){const n=Array.from(this.parentElement.children);let i=n.indexOf(e),s=n.indexOf(t);-1==i&&(i=0),-1==s&&(s=n.length);const r=[];for(let e=i+1;e<s;e++)"TEMPLATE"!=n[e].nodeName&&r.push(n[e]);for(let e of r)e.parentElement.removeChild(e)}_clear(){1==this._shouldClearAll?this._clearAll():this._clearPartial()}_clearAll(){const e=Array.from(this._container.children).filter(e=>"TEMPLATE"!=e.nodeName);for(let t of e)t.parentElement.removeChild(t),crsbinding.observation.releaseBinding(t)}_clearPartial(){this.positionStruct.removeAction()}async _renderItems(){this._clear()}createElement(e,t){const n=crsbinding.data.createReferenceTo(this._context,`${this._context}-array-item-${t}`,this._plural,t),i=this._element.content.cloneNode(!0);crsbinding.parsers.parseElement(i,n,this._singular,this._context),e.__uid=n;for(let e of i.children)e.dataset.uid=n;return i}}class I extends A{init(){this._itemsAddedHandler=this._itemsAdded.bind(this),this._itemsDeletedHandler=this._itemsDeleted.bind(this)}dispose(){crsbinding.expression.release(this._forExp),this._forExp=null,this._itemsAddedHandler=null,this._itemsDeletedHandler=null,super.dispose()}async initialize(){super.initialize();this._forExp=crsbinding.expression.compile("for (let i = 0; i < context.length; i++) { callback(context[i], i) }",["callback"],{sanitize:!1,async:!0,ctxName:this._ctxName}),crsbinding.data.setArrayEvents(this._context,this._plural,this._itemsAddedHandler,this._itemsDeletedHandler)}async _renderItems(e){super._renderItems();const t=document.createDocumentFragment();await this._forExp.function(e,e=>{e.__aId=crsbinding.data.nextArrayId();const n=this.createElement(e,e.__aId);t.appendChild(n)}),this.positionStruct.addAction(t),null==this._container.__providers&&(this._container.__providers=[]),-1==this._container.__providers.indexOf(this.id)&&this._container.__providers.push(this.id)}_itemsAdded(e,t){for(let n=0;n<e.length;n++){const i=e[n],s=t.indexOf(i);i.__aId=crsbinding.data.nextArrayId();const r=this.createElement(i,i.__aId),l=r.children[0],a=this._container.children[s+this.positionStruct.startIndex+1];this._container.insertBefore(r,a);for(let e of l.__providers||[]){const t=crsbinding.providerManager.items.get(e);t instanceof j&&t._change()}}}_itemsDeleted(e,t){if(null==e)return;const n=[],i=Array.isArray(e)?e:[e];for(let e of i){const t=e.__uid;this._container.querySelectorAll([`[data-uid="${t}"]`]).forEach(e=>n.push(e)),crsbinding.data.removeObject(t)}for(let e of n)null!=e&&(e.parentElement.removeChild(e),crsbinding.observation.releaseBinding(e))}}class C extends d{constructor(e,t,n,i,s,r){super(e,t,n,i,s,r,!1)}dispose(){crsbinding.expression.release(this._expObj),delete this._expObj.parentObj,delete this._expObj,this._eventHandler=null,super.dispose()}async initialize(){let e;this._sanitizeProperties=["fill","stroke"],this._eventHandler=this.propertyChanged.bind(this),e=-1==this._value.indexOf("?")?this._initCndAttr():-1!=this._value.indexOf(":")?this._initCndValue():this._initCndAttrValue(),-1!=this._value.indexOf("$parent")&&(this._expObj.parentObj=crsbinding.data.getValue(this._parentId),e.properties.forEach(e=>{if(-1!=e.indexOf("$parent.")){const t=e.replace("$parent.","");this._addCallback(this._parentId,t,this._eventHandler)}})),this.propertyChanged()}_initCndAttr(){const e=crsbinding.expression.sanitize(this._value,this._ctxName),t=E.split("__exp__").join(e.expression).split("__attr__").join(this._property).split("__attr-value__").join(this._property);return this._expObj=crsbinding.expression.compile(t,["element","parent"],{sanitize:!1,ctxName:this._ctxName}),this.listenOnPath(e.properties.filter(e=>-1==e.indexOf("$parent")),this._eventHandler),e}_initCndValue(){const e=crsbinding.expression.sanitize(this._value,this._ctxName),t=e.expression.split("?"),n=t[1].split(":"),i=this._sanitizeValue(n[0].trim()),s=this._sanitizeValue(n[1].trim()),r=w.split("__exp__").join(t[0].trim()).split("__attr__").join(this._property).split("__true__").join(i).split("__false__").join(s);return this._expObj=crsbinding.expression.compile(r,["element","parent"],{sanitize:!1,ctxName:this._ctxName}),this.listenOnPath(e.properties,this._eventHandler),e}_initCndAttrValue(){const e=crsbinding.expression.sanitize(this._value,this._ctxName),t=e.expression.split("?"),n=E.split("__exp__").join(t[0].trim()).split("__attr__").join(this._property).split("__attr-value__").join(t[1].trim());return this._expObj=crsbinding.expression.compile(n,["element","parent"],{sanitize:!1,ctxName:this._ctxName}),this.listenOnPath(e.properties,this._eventHandler),this.propertyChanged(),e}_sanitizeValue(e){return-1==this._sanitizeProperties.indexOf(this._property)?e:e.split("'").join("")}propertyChanged(){try{crsbinding.idleTaskManager.add(this._expObj.function(this.data,this._element,this._expObj.parentObj))}catch{return}}}const E='\nif (__exp__) {\n    element.setAttribute("__attr__", "__attr-value__");\n}\nelse {\n    element.removeAttribute("__attr__");\n}\n',w='\nif (__exp__) {\n    element.setAttribute("__attr__", "__true__");\n}\nelse {\n    element.setAttribute("__attr__", "__false__");\n}\n';class N extends d{constructor(e,t,n,i,s,r){super(e,t,n,i,s,r)}dispose(){crsbinding.expression.release(this._expObj),delete this._expObj,this._eventHandler=null,super.dispose()}async initialize(){this._eventHandler=this.propertyChanged.bind(this);const e=this._value.split("?"),t=crsbinding.expression.sanitize(e[0],this._ctxName),n=t.expression,i=e[1].split(":"),s=i[0].trim(),r=i.length>1?i[1].trim():"[]",l=f.split("__property__").join(this._property).split("__exp__").join(n).split("__true__").join(s).split("__false__").join(r);this._expObj=crsbinding.expression.compile(l,["element"],{sanitize:!1,ctxName:this._ctxName}),this.listenOnPath(t.properties,this._eventHandler),this.propertyChanged()}propertyChanged(){try{crsbinding.idleTaskManager.add(this._expObj.function(this.data,this._element))}catch{return}}}class P extends d{constructor(e,t,n,i,s,r){super(e,t,n,i,s,r)}dispose(){crsbinding.expression.release(this._expObj),delete this._expObj,this._eventHandler=null,super.dispose()}async initialize(){this._eventHandler=this.propertyChanged.bind(this);const e=crsbinding.expression.sanitize(this._value,this._ctxName),t=e.expression.split("?"),n=t[0].trim(),i=t[1].split(":"),s=i[0].trim(),r=i.length>1?i[1].trim():'""',l="requestAnimationFrame(() => element.__property__ = (__exp__) ? __true__ : __false__)".split("__property__").join(crsbinding.utils.capitalizePropertyPath(this._property)).split("__exp__").join(n).split("__true__").join(s).split("__false__").join(r);this._expObj=crsbinding.expression.compile(l,["element"],{sanitize:!1,ctxName:this._ctxName}),this.listenOnPath(e.properties,this._eventHandler),this.propertyChanged()}propertyChanged(){try{crsbinding.idleTaskManager.add(this._expObj.function(this.data,this._element))}catch{return}}}function k(e,t,n,i,s="context",r){-1!=i.indexOf("$parent.")&&(i=i.split("$parent.").join(""),t=r);const l=i.split("of"),a=l[0].trim(),o=l[1].trim();crsbinding.inflationManager.register("for-once",e,a);const c=crsbinding.data.getValue(t,o),d=crsbinding.inflationManager.get("for-once",c);e.parentElement.appendChild(d),e.parentElement.removeChild(e),crsbinding.inflationManager.unregister("for-once")}class z extends A{dispose(){super.dispose()}async _renderItems(e){super._renderItems();const t=document.createDocumentFragment();e.forEach((e,n)=>{const i=this.createElement(e,n);e.__aId=n,t.appendChild(i)}),this.positionStruct.addAction(t),null==this._container.__providers&&(this._container.__providers=[]),-1==this._container.__providers.indexOf(this.id)&&this._container.__providers.push(this.id)}}class T extends ${async initialize(){const e=this._value.split("("),t=e[0],n=["{"];e.length>0&&this._getParametersCode(e[1],n),n.push("}");const i=this._getSource(t,n.join(""));this._fn=new Function("context",i)}_getSource(e,t){return`crsbinding.events.emitter.emit("${e}", ${t});`}_getParametersCode(e,t){if(null==e)return;const n=e.split(")").join("").split(",");for(let e=0;e<n.length;e++){const i=n[e].trim();null!=this[i]?this[i](t):this._processArg(i,t),e<n.length-1&&t.push(",")}}$event(e){e.push("event: event")}$context(e){e.push("context: context")}_processArg(e,t){const n=e.split("="),i=n[0].trim(),s=this._processValue(n[1]);t.push(`${i}:${s}`)}_processValue(e){return-1!=e.indexOf("${")?e.split("${").join("context.").split("}").join(""):e}}class L extends T{async initialize(){const e=this._value.indexOf("["),t=this._value.indexOf("]"),n=this._value.substring(e+1,t).split(" ").join("").split(","),i=[`{key: "${this._value.substring(0,e).trim()}",`],s=this._value.indexOf("("),r=this._value.indexOf(")");if(-1!=s){const e=this._value.substring(s+1,r);this._getParametersCode(e,i)}i.push("}");const l=this._getSource(n,i.join(""));this._fn=new Function("context",l)}_getSource(e,t){const n=[];for(let i of e)i=i.split("'").join("").split('"').join(""),n.push(`crsbinding.events.emitter.postMessage("${i}", ${t});`);return n.join("\n")}}function S(e,t){const n=`_${t}`;return null!=e[n]?e[n]:crsbinding.data.getValue(e._dataId,t)}function H(e,t,n){let i;n&&null!=n.__uid&&(i=S(e,t),i&&crsbinding.data.unlinkArrayItem(i)),crsbinding.data.setProperty(e._dataId,t,n),Array.isArray(n)&&(e[`_${t}`]=crsbinding.data.array(e._dataId,t)),n&&n.__uid&&crsbinding.data.linkToArrayItem(e._dataId,t,n.__uid)}class M extends ${async initialize(){const e=this._value.split("="),t=this._processRightPart(e[1].trim()),n=this._processLeftPart(e[0].trim(),t);this._fn=new Function("context","event","setProperty",n)}_processRightPart(e){return crsbinding.expression.sanitize(e,this._ctxName,!0).expression}_processLeftPart(e,t){return-1!=e.indexOf("$globals")?this._getGlobalSetter(e,t):this._getContextSetter(e,t)}_getGlobalSetter(e,t){return`setProperty({_dataId: crsbinding.$globals}, "${e.replace("$globals.","")}", ${t});`}_getContextSetter(e,t){if(e=e.replace("$context.",""),-1!=t.indexOf("context.")){const e=t.split("context."),n=e[e.length-1];t=`${"!"==e[0]?"!":""}crsbinding.data.getValue({_dataId: ${this._context}}, "${n}")`}return`setProperty({_dataId: ${this._context}}, "${e}", ${t});`}event(e){const t=crsbinding.data.getContext(this._context);crsbinding.idleTaskManager.add(this._fn(t,e,H)),e.stopPropagation()}}class V{static bind(e,t,n,i,s,r,l){return-1!=["value","checked"].indexOf(n)?new x(e,t,n,i,s,l):this["one-way"](e,t,n,i,s,l)}static"two-way"(e,t,n,i,s,r,l){return new x(e,t,n,i,s,l)}static"one-way"(e,t,n,i,s,r,l){return new g(e,t,n,i,s,l)}static once(e,t,n,i,s,r,l){return v(e,t,n,i,s)}static call(e,t,n,i,s,r,l){return new $(e,t,n,i,s,l)}static delegate(e,t,n,i,s,r,l){return new $(e,t,n,i,s,l)}static emit(e,t,n,i,s,r,l){return new T(e,t,n,i,s,l)}static post(e,t,n,i,s,r,l){return new L(e,t,n,i,s,l)}static setvalue(e,t,n,i,s,r,l){return new M(e,t,n,i,s,l)}static inner(e,t,n,i,s,r,l){return new O(e,t,n,i,s,l)}static for(e,t,n,i,s,r,l){const a=r.name.split("."),o=a.length>1?crsbinding.providerManager.providers.for[a[1]]:null;return null!=o?new o(e,t,n,i,s,l):new I(e,t,n,i,s,l)}static if(e,t,n,i,s,r,l){return"classlist"==n.toLowerCase()?new N(e,t,n,i,s,l):-1!=n.toLowerCase().indexOf("style.")?new P(e,t,n,i,s,l):new C(e,t,n,i,s,l)}static attr(e,t,n,i,s,r,l){return new j(e,t,n,i,s,l)}}const F=["STYLE"];function R(e,t,n="context",i){for(let s of e||[])-1==F.indexOf(s.nodeName)&&B(s,t,n,i)}function B(e,t,n="context",i){R(e.children,t,n,i),function(e,t,n,i){for(let s of e)D(s,t,n,i)}(Array.from(e.attributes||[]).filter(e=>"TEMPLATE"==e.ownerElement.tagName&&"for"==e.name||-1!=e.name.indexOf(".")||0==(e.value||"").indexOf("${")),t,n,i),e.children&&0==e.children.length&&-1!=(e.innerText||e.textContent||"").indexOf("${")&&V.inner(e,t,null,null,n,null,i)}function D(e,t,n,i){const s=e.name.split(".");let r=2==s.length?s[0]:s.slice(0,s.length-1).join("."),l="for"==r?r:s[s.length-1];0==r.length&&"$"==e.value[0]&&(r=l,l="attr");const a=V[l](e.ownerElement,t,r,e.value,n,e,i);return null!=a&&"AttrProvider"==a.constructor.name||e.ownerElement.removeAttribute(e.nodeName),a}function q(e){crsbinding.providerManager.releaseElement(e)}globalThis.requestIdleCallback=globalThis.requestIdleCallback||function(e){const t=Date.now();return setTimeout((function(){e({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})}),1)},globalThis.cancelIdleCallback=globalThis.cancelIdleCallback||function(e){clearTimeout(e)};function U(e,t){this.addEventListener(e,t),this._domEvents.push({event:e,callback:t})}function G(e,t){const n=this._domEvents.find(n=>n.event==e&&n.callback==t);null!=n&&(this.removeEventListener(n.event,n.callback),this._domEvents.splice(this._domEvents.indexOf(n),1),n.callback=null,n.event=null)}class Q{constructor(e){this.inflateSrc=[],this.deflateSrc=[],this._ctxName=e}dispose(){this.inflateSrc=null,this.deflateSrc=null}generateCodeFor(e){const t=e.content.children[0];this.path="element",this._processElement(t);const n=this.inflateSrc.join("\n"),i=this.deflateSrc.join("\n");return{inflate:new Function("element",this._ctxName,n),deflate:new Function("element",this._ctxName,i)}}_processElement(e){this._processInnerText(e),this._processAttributes(e);const t=this.path;for(let n=0;n<e.children.length;n++)this.path=`${t}.children[${n}]`,this._processElement(e.children[n])}_processInnerText(e){const t=(e.innerHTML||"").trim(),n=e.textContent?"textContent":"innerText";if(0==t.indexOf("${")){let e=t.substr(2,t.length-3);e=crsbinding.expression.sanitize(e,this._ctxName).expression,this.inflateSrc.push(`${this.path}.${n} = ${e};`),this.deflateSrc.push(`${this.path}.${n} = "";`)}}_processAttributes(e){const t=Array.from(e.attributes).filter(e=>-1!=e.value.indexOf("${")||-1!=e.name.indexOf(".if"));for(let e of t)-1!=e.value.indexOf("${")?this._processAttrValue(e):this._processAttrCondition(e)}_processAttrValue(e){const t=e.value.trim();let n=t.substr(2,t.length-3);if(n=crsbinding.expression.sanitize(n,this._ctxName).expression,"xlink:href"==e.name)this.inflateSrc.push(`${this.path}.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", ${n});`);else{const t=n.split("?");this.inflateSrc.push(`if (${t[0].trim()} != null) {${this.path}.setAttribute("${e.name}", ${n});}`)}this.deflateSrc.push(`${this.path}.removeAttribute("${e.name}");`),e.ownerElement.removeAttribute(e.name)}_processAttrCondition(e){return 0==e.name.trim().indexOf("style")?this._processStyle(e):0==e.name.trim().indexOf("classlist")?this._processClassList(e):-1!=e.name.trim().indexOf(".if")?this._processConditional(e):void 0}_processStyle(e){const t=e.name.split(".")[1],n=crsbinding.expression.sanitize(e.value.trim(),this._ctxName).expression;this.inflateSrc.push(`${this.path}.style.${t} = ${n};`),this.deflateSrc.push(`${this.path}.style.${t} = "";`),e.ownerElement.removeAttribute(e.name)}_processClassList(e){const t=e.value.split("?"),n=crsbinding.expression.sanitize(t[0],this._ctxName).expression,i=t[1].split(":"),s=i[0].trim(),r=i.length>1?i[1].trim():"",l=-1==s.indexOf("[")?s:`...${s}`;let a=`if (${n}) {${this.path}.classList.add(${l});}`;if(r.length>0){let e=-1==r.indexOf("[")?r:`...${r}`;a+=`else {${this.path}.classList.add(${e});}`}const o=`while (${this.path}.classList.length > 0) {${this.path}.classList.remove(${this.path}.classList.item(0));}`;this.inflateSrc.push(a),this.deflateSrc.push(o),e.ownerElement.removeAttribute(e.name)}_processConditional(e){const t=e.name.split(".if")[0].trim(),n=e.value.split("?");let i=[`if(${crsbinding.expression.sanitize(n[0].trim(),this._ctxName).expression})`];const s=n.length>1?n[1].trim():`"${t}"`;if(-1==s.indexOf(":"))i.push("{"),i.push(`${this.path}.setAttribute("${t}", ${s});`),i.push("}"),i.push(`else {${this.path}.removeAttribute("${t}")}`);else{const e=n[1].split(":");i.push("{"),i.push(`${this.path}.setAttribute("${t}", ${e[0].trim()});`),i.push("}"),i.push(`else {${this.path}.setAttribute("${t}", ${e[1].trim()})}`)}this.inflateSrc.push(i.join("")),this.deflateSrc.push(`${this.path}.removeAttribute("${t}")`),e.ownerElement.removeAttribute(e.name)}}const X=["pop","splice"],Y=["push"];function J(e,t){const n=e[t];return"function"==typeof n?(...n)=>{const i=e[t](...n);return-1!=X.indexOf(t)?(!function(e,t){const n=e.__id,i=e.__property;crsbinding.data.arrayItemsRemoved(n,i,t,e)}(e,i),"splice"==t&&n.length>2&&(n=n.splice(2,n.length),K(e,n))):-1!=Y.indexOf(t)&&K(e,n),i}:n}function K(e,t){const n=e.__id,i=e.__property;crsbinding.data.arrayItemsAdded(n,i,t,e)}const W=new Map,Z=new Map,ee=new Map,te=new Map,ne=new Map,ie={nextId:0,nextTriggerId:0,nextArrayId:0};function se(){return le("nextId")}function re(){return le("nextTriggerId")}function le(e){const t=ie[e];return ie[e]+=1,t}function ae(e,t){const n=b(Z.get(e),t);null!=n&&ce(n,e,t)}function oe(e,t){"object"==typeof e&&(e=e.__uid||e._dataId);const n=Z.get(e);if(null==t){const t=me(n);for(let i of t)ce(n[i],e,i)}else{if(-1!=t.indexOf("."))return ae(e,t);if(null==n)return;if(null==n[t])return;ce(n[t],e,t)}}function ce(e,t,n){if(null!=e.__functions)for(let i of e.__functions){i(n,be.getValue(t,n))}if(null!=e.__trigger){const i=te.get(e.__trigger);if(1!=i.frozen){i.frozen=!0;for(let e of i.values)e.id==t&&e.path==n||crsbinding.data.updateUI(e.id,e.path);delete i.frozen}}const i=me(e);for(let s of i)ce(e[s],t,`${n}.${s}`)}function de(e,t,n){e[t]=e[t]||{},e[t].__functions=e[t].__functions||[],e[t].__functions.push(n)}function he(e,t,n){let i=e;const s=t.split(".");for(let e=0;e<s.length-1;e++){const t=s[e];null==i[t]&&(i[t]={}),i=i[t]}n&&n(i,s[s.length-1])}function _e(e,t,n){return e[t]!==n&&(e[t]=n,!0)}function pe(e,t,n){let i=!0;return he(e,t,(e,t)=>i=_e(e,t,n)),i}function ue(e,t,n,i){const s=ee.get(n)||{},r=s[i]||{};r.originId==e&&r.originProperty==t||(r.originId=e,r.originProperty=t,s[i]=r,ee.set(n,s))}function fe(e,t){const n=te.get(t),i=n.values.filter(t=>t.id==e);for(let e of i){const t=n.values.indexOf(e);n.values.splice(t,1)}}function ge(e,t,n,i,s,r){const l=e[t],a=n[i]=n[i]||{};if(null!=l.__trigger){a.__trigger=l.__trigger,te.get(l.__trigger).values.push({id:s,path:r})}const o=me(l);for(let e of o)ge(l,e,a,e,s,`${r}.${e}`)}function me(e){return Object.getOwnPropertyNames(e).filter(e=>-1==e.indexOf("__"))}function xe(e){ne.delete(e),function(e){(function(e){const t=Array.from(W).filter(t=>t[1].refId==e);for(let e of t)xe(e[1].id)})(e),W.delete(e),0==W.size&&(ie.nextId=0,ie.nextArrayId=0)}(e),function(e){Z.delete(e)}(e),function(e){const t=Array.from(ee).filter(t=>t[0]==e||t[1].value&&t[1].value.originId==e);for(let e of t)ee.delete(e[0])}(e),function(e){const t=Array.from(te);for(let n of t){const t=n[1].values.findIndex(t=>t.id==e);-1!=t&&(n[1].values.splice(t,1),0==n.values.length&&te.delete(n[0]))}0==te.size&&(ie.nextTriggerId=0)}(e)}const be={details:{data:W,callbacks:Z,updates:ee,triggers:te,context:ne},link:function(e,t,n,i,s){"object"!=typeof s||null===s?(ue(e,t,n,i),ue(n,i,e,t),function(e,t,n,i){let s=Z.get(e),r=Z.get(n);const l=b(s,`${t}.__trigger`);if(null!=l){r[i]=r[i]||{},r[i].__trigger=l,te.get(l).values.push({id:n,path:i})}}(e,t,n,i)):function(e,t,n,i){let s=Z.get(e),r=Z.get(n);-1==t.indexOf(".")?ge(s,t,r,i,n,i):he(r,i,(e,r)=>{e[r]=e[r]||{};const l=t.split("."),a=l[l.length-1],o=l.splice(0,l.length-1).join();ge(b(s,o),a,e,r,n,i)})}(e,t,n,i)},setName(e,t){W.get(e).name=t},addObject(e,t={}){const n=se();return W.set(n,{id:n,name:e,type:"data",data:t}),Z.set(n,{}),n},removeObject:xe,addContext(e,t){ne.set(e,t)},addCallback(e,t,n){const i=Z.get(e);return-1==t.indexOf(".")?de(i,t,n):function(e,t,n){he(e,t,(e,t)=>{de(e,t,n)})}(i,t,n)},setProperty(e,t,n,i,s){"object"==typeof e&&(e=e.__uid||e._dataId);let r=W.get(e);if("boolean"==s||"boolean"==typeof n?n=Boolean(n):("number"==s||null==s&&"object"!=typeof n&&0==isNaN(n))&&(n=Number(n)),"data"==r.type){r=W.get(e).data,1==(-1==t.indexOf(".")?_e(r,t,n):pe(r,t,n))&&(!function(e,t,n){const i=ee.get(e);null!=i&&null!=i[t]&&be.setProperty(i[t].originId,i[t].originProperty,n);const s=ne.get(e),r=`${t}Changed`;s&&s[r]&&s[r](n)}(e,t,n),oe(e,t))}else this.setReferenceValue(e,t,n,r.refId,r.path,r.aId,i)},getValue(e,t){"object"==typeof e&&(e=e.__uid||e._dataId);const n=W.get(Number(e));if("data"==n.type){const e=n.data;return null==t?e:-1==t.indexOf(".")?function(e,t){return e[t]}(e,t):function(e,t){return b(e,t)}(e,t)}{const e=n.refId;return this.getReferenceValue(e,t,n.path,n.aId)}},getContext:e=>ne.get(e),getReferenceValue(e,t,n,i){const s=W.get(e);if("data"==s.type){if(void 0===i){const i=null==t?n:`${n}.${t}`;return this.getValue(e,i)}{const s=this.getValue(e,n);let r;if(Array.isArray(s))r=s.find(e=>e.__aId==i);else{const e=s.get(i);r={key:i,value:e}}return null==t||null==r?r:b(r,t)}}{let e=`${s.path}.${n}`;return this.getReferenceValue(s.refId,t,e)}},setReferenceValue(e,t,n,i,s,r,l){const a=W.get(i);if("data"!=a.type){let e=`${a.path}.${path}`;return this.getReferenceValue(a.refId,t,e)}{let i=b(a.data,s);null!=r&&(i=i.find(e=>e.__aId==r)),"context"!=l&&(t=t.split(`${l}.`).join("")),pe(i,t,n),ae(e,t)}},createReferenceTo:function(e,t,n,i){const s=se(),r={id:s,name:t,type:"ref",refId:e,path:n};return void 0!==i&&(r.aId=i),W.set(s,r),Z.set(s,{}),s},clear(){W.forEach((e,t)=>{delete e.data}),W.clear(),ie.nextId=0,ie.nextArrayId=0},makeShared:function(e,t,n){"object"==typeof e&&(e=e.__uid||e._dataId);const i=Z.get(e);for(let s of n){const n=`${t}.${s}`;he(i,n,(t,i)=>{null==t[i]&&(t[i]={});const s=re();te.set(s,{values:[{id:e,path:n}]}),t[i].__trigger=s})}},updateUI:oe,array(e,t){return"object"==typeof e&&(e=e._dataId),function(e,t,n){return null==e?null:(e.__id=t,e.__property=n,new Proxy(e,{get:J}))}(this.getValue(e,t),e,t)},setArrayEvents:function(e,t,n,i){he(Z.get(e),t,(e,t)=>{e[t]=e[t]||{},e[t].__itemsAdded=e[t].itemsAdded||[],e[t].__itemsAdded.push(n),e[t].__itemsDeleted=e[t].itemsDeleted||[],e[t].__itemsDeleted.push(i)})},notifyArrayItemsAdded:function(e,t){crsbinding.data.arrayItemsAdded(e.__id,e.__property,Array.isArray(t)?t:[t],e)},notifyArrayItemsRemoved:function(e,t){crsbinding.data.arrayItemsRemoved(e.__id,e.__property,Array.isArray(t)?t:[t],e)},arrayItemsAdded:function(e,t,n,i){const s=b(Z.get(e),t);for(let e of s.__itemsAdded||[])e(n,i)},arrayItemsRemoved:function(e,t,n,i){const s=b(Z.get(e),t);for(let e of s.__itemsDeleted||[])e(n,i)},linkToArrayItem:function(e,t,n){let i=b(Z.get(e),t);if(null==i)return;let s=Z.get(n);const r=me(i);for(let e of r)ge(i,e,s,e,n,e)},unlinkArrayItem:function(e){!function e(t,n){const i=me(t);for(let s of i){const i=t[s].__trigger;null!=i&&(delete t[s].__trigger,fe(n,i)),"object"==typeof t[s]&&e(t[s])}}(Z.get(e.__uid),e.__uid)},nextArrayId:function(){return le("nextArrayId")},removeCallback:function(e,t,n){const i=Z.get(e);if(null==i)return;const s=b(i,t);if(s.__functions){const e=s.__functions.indexOf(n);-1!=e&&(s.__functions.splice(e,1),0==s.__functions.length&&delete s.__functions)}}};class ve extends HTMLElement{constructor(){super(),this._dataId=crsbinding.data.addObject(this.constructor.name),crsbinding.data.addContext(this._dataId,this),crsbinding.dom.enableEvents(this),this.__properties=new Map}dispose(){this._disposing=!0,crsbinding.dom.disableEvents(this)}async connectedCallback(){if(null!=this.preLoad){const e=(e,t)=>{crsbinding.data.setProperty(this._dataId,e,t)};await this.preLoad(e)}null!=this.html&&(this.innerHTML=await fetch(this.html).then(e=>e.text()),crsbinding.parsers.parseElements(this.children,this._dataId)),this.isReady=!0,this.dispatchEvent(new CustomEvent("ready")),requestAnimationFrame(()=>{const e=this.getAttribute("name");null!=e&&crsbinding.data.setName(this._dataId,e)}),this.__properties.forEach((e,t)=>crsbinding.data.setProperty(this._dataId,t,e)),this.__properties.clear(),delete this.__properties,null!=this.load&&this.load()}async disconnectedCallback(){this.dispose(),crsbinding.utils.disposeProperties(this),crsbinding.observation.releaseBinding(this),crsbinding.data.removeObject(this._dataId)}getProperty(e){return S(this,e)}setProperty(e,t,n=!1){if(1!=this.isReady&&!1===n)return this.__properties.set(e,t);H(this,e,t)}}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};const ye={_expFn:new Map,data:be,idleTaskManager:new class{constructor(){this.processing=!1,this._list=[]}dispose(){this._list=null}add(e){e&&this._list.push(e),!this.processing&&this._processQueue()}_processQueue(){if(null==requestIdleCallback)return this._runNextFunction();this.processing=!0,requestIdleCallback(e=>{for(;(e.timeRemaining()>0||e.didTimeout)&&this._list.length;)this._runNextFunction();this.processing=!1},{timeout:1e3})}_runNextFunction(){let e=this._list.shift();e&&e()}},providerManager:new class{constructor(){this._nextId=0,this.items=new Map,this.providers={for:{map:z,once:k}}}async register(e){e.id=this._nextId,null==e._element.__providers&&Reflect.set(e._element,"__providers",[]),e._element.__providers.push(this._nextId),this.items.set(this._nextId,e),this._nextId+=1}async releaseElement(e){for(let t of e.children||[])await this.releaseElement(t);if(null!=e.__providers){for(let t of e.__providers){const e=this.items.get(t);this.items.delete(t),e&&e.dispose()}e.__providers=null,0==this.items.size&&(this._nextId=0)}}},inflationManager:new class{constructor(){this._items=new Map}dispose(){this._items.clear(),this._items=null}register(e,t,n="context"){const i=new Q(n),s=i.generateCodeFor(t);i.dispose(),this._items.set(e,{template:t,inflate:s.inflate,deflate:s.deflate})}unregister(e){const t=this._items.get(e);null!=t&&(t.template=null,t.inflate=null,t.defaulte=null,this._items.delete(e))}get(e,t){const n=this._items.get(e);if(null==n)return null;const i=document.createDocumentFragment();for(let s of t){const t=n.template.content.cloneNode(!0);this.inflate(e,t.children[0],s,n.inflate),i.appendChild(t)}return i.querySelectorAll('[remove="true"]').forEach(e=>e.parentElement.removeChild(e)),i}inflate(e,t,n,i=null){(i||this._items.get(e).inflate)(t,n)}deflate(e,t){const n=this._items.get(e).deflate;if(Array.isArray(t))for(let e of t)n(e);else n(t)}},valueConverters:new class{constructor(){this._converters=new Map}dispose(){this._converters.clear(),this._converters=null}register(e,t){this._converters.set(e,t)}unregister(e){this._converters.delete(e)}convertTo(e,t){const n=this._converters.get(e);return null==n?t:n.convertTo(t)}convertBack(e,t){const n=this._converters.get(e);return null==n?t:n.convertBack(t)}},expression:{sanitize:function(e,d="context",h=!1){const _="context"!=d,p=`${d}.`,u=function(e,t){let n=[],s=[],r=!1;for(let t=0;t<e.length;t++){const l=e[t];1==r&&"$"==l&&"{"==e[t+1]&&(r=!1),1==r?-1==o.indexOf(l)?s.push(l):(c(n,s,l),r=!1):-1!=i.indexOf(l)?(c(n,s,l),-1!=o.indexOf(l)&&(r=!0)):s.push(l)}s.length>0&&n.push(s.join(""));null!=t&&(n=function e(t,n){const i=t.indexOf(n);if(-1==i)return t;"."==t[i+1]&&(t.splice(i,2),-1!=t.indexOf(n)&&e(t,n));return t}(n,t));return n}(e,_?d:null);if(1==u.length)return{isLiteral:!1,expression:`${p}${u[0]}`,properties:[e]};const f=[],g=-1!=e.indexOf("${");let m=null,x=[],b=[];for(let e=0;e<u.length;e++){const t=u[e];-1!=a.indexOf(m)||-1!=i.indexOf(t)&&-1==s.indexOf(t)?(m=t,x.length>0&&(0!=g&&"}"!=m||isNaN(x)&&(-1==l.indexOf(x[0])&&":"!=t&&b.push(e-x.length),f.push(n(`${x.join("")}`))),x.length=0)):("$"==m&&-1!=r.indexOf(t)?x.push(`$${t}`):x.push(t),m=t)}_&&x.length>0&&(0!=g&&"}"!=m||isNaN(x)&&(b.push(u.length-1),f.push(n(`${x.join("")}`)))),0==b.length&&-1!=e.indexOf(".")&&-1==e.indexOf("$globals")&&-1==e.indexOf("$context")&&-1==e.indexOf("$event")&&-1==e.indexOf("$parent")&&-1==e.indexOf("$data")&&"{"!=e.trim()[0]&&b.push(0);for(let e=0;e<b.length;e++)u.splice(e+b[e],0,p);if(1==h){let e=0;for(;e<u.length;)"$"==u[e]&&"{"==u[e+1]&&(u.splice(e,2),t(u,e,"}")),e++}return{isLiteral:g,expression:u.join("").split("$globals").join("crsbinding.data.globals").split("$event").join("event").split("$context").join("context").split("$data").join("crsbinding.data.getValue").split("$parent").join("parent"),properties:f}},compile:function(t,n,i){n=n||[];let s=!0,r=!1,l="context";if(null!=i&&(null!=i.sanitize&&(s=i.sanitize),null!=i.async&&(r=i.async),null!=i.ctxName&&(l=i.ctxName)),crsbinding._expFn.has(t)){const e=crsbinding._expFn.get(t);return e.count+=1,e}let a,o=t;if(1==s){if(a=crsbinding.expression.sanitize(t,l),crsbinding._expFn.has(a.expression)){const e=crsbinding._expFn.get(a.expression);return e.count+=1,e}o=!0===a.isLiteral?["return `",a.expression,"`"].join(""):`return ${a.expression}`,a.expression.split(".").length>2&&(o=`try { ${o} } catch(error) { return null }`)}else a={expression:t};const c={function:1==r?new e(l,...n,o):new Function(l,...n,o),parameters:a,count:1};return crsbinding._expFn.set(a.expression,c),c},release:function(e){if(null==e||"object"!=typeof e)return;const t=e.parameters.expression;if(crsbinding._expFn.has(t)){const e=crsbinding._expFn.get(t);e.count-=1,0==e.count&&(e.function=null,e.parameters=null,crsbinding._expFn.delete(t))}}},observation:{releaseBinding:q,releaseChildBinding:function(e){for(let t of e.children)q(t)}},parsers:{parseElement:B,parseElements:R},classes:{BindableElement:ve,ViewBase:class{get title(){return this.getProperty("title")}set title(e){this.setProperty("title",e)}get element(){return this._element}set element(e){this._element=e}constructor(e){this._dataId=crsbinding.data.addObject(this.constructor.name),crsbinding.data.addContext(this._dataId,this),this.element=e}async connectedCallback(){if(null!=this.preLoad){const e=(e,t)=>{crsbinding.data.setProperty(this._dataId,e,t)};await this.preLoad(e)}crsbinding.parsers.parseElement(this.element,this._dataId),this.load()}async disconnectedCallback(){crsbinding.observation.releaseBinding(this.element),crsbinding.utils.disposeProperties(this),this.element=null,crsbinding.data.removeObject(this._dataId)}getProperty(e){return S(this,e)}setProperty(e,t){H(this,e,t)}load(){this._element.style.visibility="",this._loaded=!0}},RepeatBaseProvider:A},events:{listenOn:function(e,t,n){-1==t.indexOf(".")?crsbinding.events.on(e,t.trim(),n):crsbinding.events.listenOnPath(e,t,n)},listenOnPath:function(e,t,n){t.split(".")},emitter:new class{constructor(){this._events=new Map}dispose(){this._events.clear()}on(e,t){let n=[];this._events.has(e)?n=this._events.get(e):this._events.set(e,n),-1==n.indexOf(t)&&n.push(t)}emit(e,t){if(this._events.has(e)){this._events.get(e).forEach(e=>e(t))}}remove(e,t){if(this._events.has(e)){const n=this._events.get(e),i=n.indexOf(t);-1!=i&&n.splice(i,1),0===n.length&&this._events.delete(e)}}postMessage(e,t,n){const i=n||document;Array.from(i.querySelectorAll(e)).forEach(e=>{null!=e.onMessage&&e.onMessage.call(e,t)})}}},dom:{enableEvents:function(e){e._domEvents=[],e.registerEvent=U,e.unregisterEvent=G},disableEvents:function(e){if(null!=e._domEvents){for(let t of e._domEvents)t.callback=null,t.event=null;e._domEvents.length=0,delete e._domEvents,delete e.registerEvent,delete e.unregisterEvent}}},utils:{capitalizePropertyPath:function(e){const t=e.split("-");for(let e=1;e<t.length;e++)t[e]=t[e].capitalize();return t.join("")},clone:function(e){return null==e?e:function e(t){let n=Object.getOwnPropertyNames(t).filter(e=>0==e.indexOf("__"));for(let e of n)delete t[e];n=Object.getOwnPropertyNames(t).filter(e=>-1==e.indexOf("__")&&"object"==typeof t[e]);for(let i of n)e(t[i]);return t}(Object.assign({},e))},disposeProperties:function e(t){const n=Object.getOwnPropertyNames(t).filter(e=>t[e]&&1==t[e].__isProxy);for(let i of n){const n=t[i];1!=Array.isArray(n)&&e(n),delete t[i]}}}};globalThis.crsbinding=ye,ye.$globals=ye.data.addObject("globals"),ye.data.globals=ye.data.getValue(ye.$globals);export{ye as crsbinding};
