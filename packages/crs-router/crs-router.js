import{getHashParameters as h,getRouteParameters as d}from"./crs-utils.js";import"./crs-loader.js";class c extends HTMLElement{async connectedCallback(){this._loader=document.createElement("crs-loader"),this.showLoader(!1),document.documentElement.appendChild(this._loader),await this._loadRoutes();const t=await import(this.routesDef["auto-nav"]==!0?"./crs-url-provider.js":"./crs-static-provider.js");this._provider=new t.NavigationProvider(this),requestAnimationFrame(()=>{this._rect=this.getBoundingClientRect(),this._loader.style.left=`${this._rect.width/2-30}px`,this._loader.style.top=`${this._rect.top+100}px`}),this.dispatchEvent(new CustomEvent("ready"))}disconnectedCallback(){this.routesDef=null,this._provider.dispose(),this._provider=null,this._loader=null,this._rect=null}showLoader(e){this._loader.style.display=e==!0?"":"none"}async goto(e,t,i="view"){let r=!0;const n=setTimeout(()=>{clearTimeout(n),r==!0&&this.showLoader(!0)},200),l=e.indexOf("/")==-1?h:d;e.indexOf("/")!=-1&&(e=e.split("/")[0]);const o=this.routesDef.routes.find(s=>s[i]===e);if(o==null)return this._loadView({title:"404",hash:"#404",view:"404","html-only":!0});await this._loadView(o),this.viewModel!=null&&(this.viewModel.element=this,this.viewModel.parameters=t||await l(window.location.hash,o).parameters,this.viewModel.connectedCallback&&await this.viewModel.connectedCallback(),this.viewModel.parameters!=null&&this.viewModel.parametersChanged&&this.viewModel.parametersChanged(this.viewModel.parameters),this.viewModel.showScreen&&this.viewModel.showScreen()),r=!1,this.showLoader(!1)}async _loadRoutes(){const e=this.getAttribute("routes")||"/app/routes.json";return fetch(e).then(t=>t.text()).then(t=>this.routesDef=JSON.parse(t))}async _loadView(e){const t=document.body.dataset.appPath||"";this.routesDef["auto-hide"]==!0&&(this.style.visibility="hidden"),this.viewModel!=null&&(this.viewModel.disconnectedCallback&&this.viewModel.disconnectedCallback(),this.viewDisposedCallback&&this.viewDisposedCallback(this.viewModel),delete this.viewModel.element,delete this.viewModel);const i=this.routesDef.root||"app";let r,n="";const l=[];let o=null;if(e.resources!=null){o={};for(let s of e.resources)l.push(fetch(`${t}/${i}/${e.view}/${s.path}`).then(a=>a[s.type||"text"]()).then(a=>o[s.name]=a))}e.js!=null&&l.push(this._loadTempJS(e.js)),l.push(fetch(`${t}/${i}/${e.view}/${e.view}.html`).then(s=>s.text()).then(s=>r=s)),e.hasStyle===!0&&l.push(fetch(`${t}/styles/views/${e.view}.css`).then(s=>s.text()).then(s=>n=`<style>${s}</style>`)),await Promise.all(l).then(async()=>{if(this.innerHTML=`${n}
${r}`,e["html-only"]!=!0){const s=await import(`${t}/${i}/${e.view}/${e.view}.js`),a=new s.default;this.viewModel=this.viewCreatedCallback!=null?this.viewCreatedCallback(a):a,this.viewModel.element=this,this.viewModel.title=e.title}else this.style.visibility="";o!=null&&(this.viewModel.resources=o)})}async _loadTempJS(e){for(let t of e){if(document.head.querySelector(`script[src="${t}"]`))continue;const i=document.createElement("script");i.type="text/javascript",i.src=t,i.type="module",document.head.appendChild(i)}}}customElements.define("crs-router",c);export{c as Router};
