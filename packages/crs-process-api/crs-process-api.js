var u=class{constructor(){this._schemas={},crsbinding.events.emitter.on("run-process",this._runProcess.bind(this))}_runProcess(t){return new Promise(async(e,s)=>{let i=t.step.action,n=t.step.args.schema,l=this._schemas[n];if(l==null&&crs.process.fetch!=null&&(l=await crs.process.fetch(t.step),this.add(l)),l==null)throw new Error(`process "${n}" not in registry and not loaded.`);let c=l[i];c.name=i,await $(c,t.parameters);let d=await crs.process.run(t.context,c,t.item,null,t.prefixes).catch(o=>{let b=c.aborted==!0?"crs-process-aborted":"crs-process-error";crsbinding.events.emitter.emit(b,{step:c.currentStep,error:o}),t.step.aborted=!0}),r=t.step.args?.target;r!=null&&await crs.process.setValue(r,d,t.context,t.process,t.item),e(d)})}add(t){this._schemas[t.id]=t}remove(t){delete this._schemas[t.id]}};async function $(a,t){if(t!=null){a.parameters=a.parameters||{};for(let[e,s]of Object.entries(t))a.parameters[e]=s}}var m=class{static run(t,e,s,i,n){return new Promise(async(l,c)=>{e=JSON.parse(JSON.stringify(e)),e.data=e.data||{},e.context=t,e.functions={},e.text=i,e.expCache={},f(n,e),e.bindable==!0&&(crs.intent.binding==null&&await crs.modules.get("binding"),await crs.intent.binding.create_context(null,t,e,null)),await crsbinding.events.emitter.emit("process-starting",e),crsbinding.idleTaskManager.add(async()=>{let d;await g(t,e,s).catch(r=>{e.aborted=!0,c({process:e.name,step:e.currentStep,error:r})}),await this.runStep(e.steps.start,t,e,s).then(async()=>{d=e.result,await this.cleanProcess(e)}).then(()=>l(d)).catch(r=>{e.aborted=!0,c({process:e.name,step:e.currentStep,error:r})})})})}static async runStep(t,e=null,s=null,i=null){if(t==null)return;await y("binding_before",t,e,s,i);let n;if(t.type!=null&&(crs.intent[t.type]==null&&await crs.modules.get(t.type),n=await crs.intent[t.type].perform(t,e,s,i)),t.args?.log!=null){let l=await this.getValue(t.args.log,e,s,i);console.log(l)}if(await y("binding_after",t,e,s,i),s?.aborted!==!0&&t.aborted!==!0){let l=s?.steps?.[t.alt_next_step||t.next_step];if(s!=null&&(s.currentStep=t.next_step),l!=null)return await this.runStep(l,e,s,i)}return n}static async getValue(t,e=null,s=null,i=null){if(typeof t!="string"||t.indexOf("${")==0||t.indexOf("$template")!=-1)return t;if(t=="$context")return e;if(t=="$process")return s;if(t=="$item")return i;if(t.indexOf("$")==-1)return t;if(t.indexOf("$binding")!=-1)return crsbinding.data.getValue(s.parameters.bId,t.replace("$binding.",""));if(t.indexOf("$fn")!=-1&&(t=t.split("$fn").join("")),t=s?.expCache==null?t:w(t,s),t.indexOf("rgb(")!=-1)return t;let n=s?.functions?.[t];if(n==null){let l=t.split("$").join("");n=new Function("context","process","item",`return ${l};`),s!=null&&s.functions!=null&&(s.functions[t]=n)}return n(e,s,i)}static async setValue(t,e,s,i,n){let l;if(t=i?.expCache==null?t:w(t,i),t.indexOf("$binding")!=-1){let d=i.parameters?.bId,r=t.split(".")[1];return crsbinding.data.setProperty(d,r,e)}t.indexOf("$item")!=-1?(l=n,t=t.replace("$item.","")):t.indexOf("$process")!=-1?(l=i,t=t.replace("$process.","")):(l=s,t=t.replace("$context.",""));let c=l;if(t.indexOf(".")==-1)c[t]=await this.getValue(e,s,i,n);else{let d=t.split(".");for(let r=0;r<d.length-1;r++){let o=d[r];c=c[o]=c[o]||{}}e=await this.getValue(e,s,i,n),c[d[d.length-1]]=e}}static async cleanProcess(t){t.bindable==!0&&crsbinding.data.removeObject(t.parameters.bId),await this.cleanObject(t.data),await this.cleanObject(t.functions),delete t.context,delete t.functions,delete t.parameters,delete t.result,delete t.data,delete t.steps,delete t.text,delete t.prefixes,delete t.expCache,await crsbinding.events.emitter.emit("process-ended",t)}static async cleanObject(t){if(t==null)return;let e=Object.keys(t);for(let s of e)delete t[s];return null}};async function y(a,t,e,s,i){crs.intent.binding==null&&await crs.modules.get("binding");let n=t[a];if(n==null||s.parameters?.bId==null)return;let l=Object.keys(n);for(let c of l)await crs.intent.binding.set_property({args:{property:c,value:n[c]}},e,s,i)}async function g(a,t,e){if(t.parameters_def==null)return;t.parameters=t.parameters||{};let s=!0;for(let[i,n]of Object.entries(t.parameters_def))if(n.required===!0&&(t.parameters[i]==null&&n.default!=null&&(t.parameters[i]=await crs.process.getValue(n.default,a,t,e)),s=t.parameters[i]!=null),s===!1)throw t.aborted=!0,t.currentStep="validate process parameters",new Error(`required parameter "${i}" not set or is null`)}function f(a,t){t.prefixes=t.prefixes||{},a!=null&&Object.assign(t.prefixes,a),t.prefixes.$text="$process.text",t.prefixes.$data="$process.data",t.prefixes.$parameters="$process.parameters",t.prefixes.$bId="$process.parameters.bId",t.prefixes.$global="globalThis",t.prefixes.$translation='crsbinding.translations.get("$0")'}function w(a,t){if(t==null)return a;if(t.expCache[a]!=null)return t.expCache[a];let e=a,s=a.split("."),i=s[0];if(t?.prefixes[i]==null)return a;s.splice(0,1);let n=t.prefixes[i];if(n.indexOf("$0")!=-1){let l=s.join(".");a=n.replace("$0",l)}else a=a.split(i).join(n);return t.expCache[e]=a,a}async function v(a){await crs.modules.add("action",`${a}/action-systems/action-actions.js`),await crs.modules.add("array",`${a}/action-systems/array-actions.js`),await crs.modules.add("binding",`${a}/action-systems/binding-actions.js`),await crs.modules.add("component",`${a}/action-systems/component-actions.js`),await crs.modules.add("condition",`${a}/action-systems/condition-actions.js`),await crs.modules.add("console",`${a}/action-systems/console-actions.js`),await crs.modules.add("cssgrid",`${a}/action-systems/css-grid-actions.js`),await crs.modules.add("data",`${a}/action-systems/data-actions.js`),await crs.modules.add("db",`${a}/action-systems/database-actions.js`),await crs.modules.add("dom",`${a}/action-systems/dom-actions.js`),await crs.modules.add("dom_binding",`${a}/action-systems/dom-binding-actions.js`),await crs.modules.add("dom_collection",`${a}/action-systems/dom-collection-actions.js`),await crs.modules.add("dom_interactive",`${a}/action-systems/dom-interactive-actions.js`),await crs.modules.add("dom_utils",`${a}/action-systems/dom-utils-actions.js`),await crs.modules.add("dom_widget",`${a}/action-systems/dom-widgets-actions.js`),await crs.modules.add("events",`${a}/action-systems/events-actions.js`),await crs.modules.add("files",`${a}/action-systems/files-actions.js`),await crs.modules.add("fs",`${a}/action-systems/fs-actions.js`),await crs.modules.add("loop",`${a}/action-systems/loop-actions.js`),await crs.modules.add("math",`${a}/action-systems/math-actions.js`),await crs.modules.add("media",`${a}/action-systems/media-actions.js`),await crs.modules.add("module",`${a}/action-systems/module-actions.js`),await crs.modules.add("object",`${a}/action-systems/object-actions.js`),await crs.modules.add("process",`${a}/action-systems/process-actions.js`),await crs.modules.add("random",`${a}/action-systems/random-actions.js`),await crs.modules.add("rest_services",`${a}/action-systems/rest-services-actions.js`),await crs.modules.add("session_storage",`${a}/action-systems/session-storage-actions.js`),await crs.modules.add("local_storage",`${a}/action-systems/local-storage-actions.js`),await crs.modules.add("string",`${a}/action-systems/string-actions.js`),await crs.modules.add("system",`${a}/action-systems/system-actions.js`),await crs.modules.add("translations",`${a}/action-systems/translations-actions.js`),await crs.modules.add("validate",`${a}/action-systems/validate-actions.js`),await crs.modules.add("fixed_layout",`${a}/action-systems/fixed-layout-actions.js`),await crs.modules.add("colors",`${a}/action-systems/colors-actions.js`),await crs.modules.add("styles",`${a}/action-systems/styles-actions.js`),await crs.modules.add("compile",`${a}/action-systems/compile-actions.js`),await crs.modules.add("date",`${a}/action-systems/date-actions.js`),await crs.modules.add("markdown",`${a}/action-systems/markdown-actions.js`),await crs.modules.add("html",`${a}/action-systems/html-actions.js`),await crs.modules.add("schema",`${a}/action-systems/schema-actions.js`),crs.dom=(await crs.modules.get("dom")).DomActions}globalThis.crs=globalThis.crs||{};globalThis.crs.intent={};globalThis.crs.processSchemaRegistry=new u;globalThis.crs.process=m;globalThis.crs.AsyncFunction=Object.getPrototypeOf(async function(){}).constructor;globalThis.crs.call=async(a,t,e,s,i,n,l=null)=>{crs.intent[a]==null&&await crs.modules.get(a),i==null&&(i={expCache:{},functions:{}},f(l,i));let c=crs.intent[a];return c[t]==null?await c.perform({action:t,args:e},s,i,n):await c[t]({args:e},s,i,n)};globalThis.crs.getNextStep=(a,t)=>typeof t=="object"?t:crsbinding.utils.getValueOnPath(a.steps,t);crsbinding.events.emitter.on("crs-process-error",a=>{console.error(a.error)});export{v as initialize};
