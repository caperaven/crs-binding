import{callFunctionOnPath as V}from"./action-actions.js";class _{static async perform(e,a,t,n){await this[e.action]?.(e,a,t,n)}static async notify_ready(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n);r.dataset.ready="true",r.dispatchEvent(new CustomEvent("ready"))}static async call_on_element(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n),s=await V(r,e,a,t,n);return e.args.target!=null&&await crs.process.setValue(e.args.target,s,a,t,n),s}static async get_property(e,a,t,n){const r=await crs.dom.get_element(e,a,t,n),s=await crsbinding.utils.getValueOnPath(r,e.args.property);return e.args.target!=null&&await crs.process.setValue(e.args.target,s,a,t,n),s}static async set_properties(e,a,t,n){const r=await crs.dom.get_element(e,a,t,n),s=await crs.process.getValue(e.args.properties,a,t,n),c=Object.keys(s);for(let o of c)r[o]=await crs.process.getValue(s[o],a,t,n)}static async set_attribute(e,a,t,n){(await crs.dom.get_element(e.args.element,a,t,n)).setAttribute(e.args.attr,await crs.process.getValue(e.args.value,a,t,n))}static async get_attribute(e,a,t,n){const s=(await crs.dom.get_element(e.args.element,a,t,n))?.getAttribute(e.args.attr);return e.args.target!=null&&await crs.process.setValue(e.args.target,s,a,t,n),s}static async add_class(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n),s=await crs.process.getValue(e.args.value,a,t,n);let c=Array.isArray(s)==!0?s:[s];r.classList.add(...c)}static async remove_class(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n),s=await crs.process.getValue(e.args.value,a,t,n);let c=Array.isArray(s)==!0?s:[s];r.classList.remove(...c)}static async set_style(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n);r.style[e.args.style]=await crs.process.getValue(e.args.value,a,t,n)}static async set_styles(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n);for(let s of Object.keys(e.args.styles))r.style[s]=await crs.process.getValue(e.args.styles[s],a,t,n)}static async get_style(e,a,t,n){const s=(await crs.dom.get_element(e.args.element,a,t,n))?.style[e.args.style];return e.args.target!=null&&await crs.process.setValue(e.args.target,s,a,t,n),s}static async set_text(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n);r.textContent=await crs.process.getValue(e.args.value,a,t,n)}static async get_text(e,a,t,n){const s=(await crs.dom.get_element(e.args.element,a,t,n)).textContent;return e.args.target!=null&&await crs.process.setValue(e.args.target,s,a,t,n),s}static async get_element(e,a,t,n){if(e==null)return null;if(e instanceof HTMLElement||e instanceof DocumentFragment||e._dataId!=null)return e;if(typeof e=="string")return document.querySelector(e);let r=await crs.process.getValue(e.args.element,a,t,n);return typeof r=="string"&&(r=document.querySelector(r)),e.args.target!=null&&await crs.process.setValue(e.args.target,r,a,t,n),r}static async create_element(e,a,t,n){const r=await crs.dom.get_element(e.args.parent,a,t,n),s=document.createElement(e.args.tag_name),c=Object.keys(e.args.attributes||{}),o=Object.keys(e.args.styles||{}),m=e.args.classes||[],d=Object.keys(e.args.dataset||{});for(let l of c)s.setAttribute(l,await crs.process.getValue(e.args.attributes[l],a,t,n));for(let l of o)s.style[l]=await crs.process.getValue(e.args.styles[l],a,t,n);for(let l of m)s.classList.add(l);for(let l of d)s.dataset[l]=await crs.process.getValue(e.args.dataset[l],a,t,n);if(e.args.text_content!=null&&(s.textContent=await crs.process.getValue(e.args.text_content,a,t,n)),e.args.id!=null&&(s.id=e.args.id),e.args.children!=null)for(let l of e.args.children)l.parent=s,await this.create_element({args:l},a,t,n);return r?.content!=null?r.content.appendChild(s):r?.appendChild(s),e.args.target!=null&&await crs.process.setValue(e.args.target,s,a,t,n),s}static async get_animation_layer(e,a,t,n){const r=document.querySelector("#animation-layer");if(r!=null)return r;const s=await crs.call("dom","create_element",{parent:document.body,tag_name:"div",id:"animation-layer",dataset:{layer:"animation"},styles:{position:"fixed",inset:0,zIndex:9999999999,background:"transparent",pointerEvents:"none"}},a,t,n);return e?.args?.target!=null&&await crs.process.setValue(e.args.target,s,a,t,n),s}static async clear_animation_layer(e,a,t,n){const r=document.querySelector("#animation-layer");r!=null&&(r.innerHTML="")}static async remove_animation_layer(e,a,t,n){const r=document.querySelector("#animation-layer");r?.parentElement?.removeChild(r)}static async highlight(e,a,t,n){const r=await this.get_animation_layer(),c=(await crs.dom.get_element(e.args.target,a,t,n)).getBoundingClientRect(),o=await crs.process.getValue(e.args.classes,a,t,n),m=await crs.process.getValue(e.args.duration,a,t,n)||0,d=await crs.process.getValue(e.args.template,a,t,n);let l;const g={position:"fixed",left:`${c.left}px`,top:`${c.top}px`,width:`${c.width}px`,height:`${c.height}px`};if(d!=null?(l=d.content.cloneNode(!0).children[0],await crs.call("dom","set_styles",{element:l,styles:g}),o!=null&&l.classList.add(...o),r.appendChild(l)):l=await crs.call("dom","create_element",{parent:r,tag_name:"div",styles:g,classes:o}),m>0){const u=setTimeout(()=>{clearTimeout(u),l?.parentElement?.removeChild(l)},m)}}static async remove_element(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n);r?.parentElement?.removeChild(r),await crsbinding.providerManager.releaseElement(r)}static async clear_element(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n);if(r!=null)for(await crsbinding.observation.releaseChildBinding(r);r.firstChild!=null;)r.removeChild(r.firstChild)}static async show_widget_dialog(e,a,t,n){return new Promise(r=>{const s=h(e);document.documentElement.appendChild(s.layer),requestAnimationFrame(async()=>{await b(s.widget.id,e.args.html,e.args.url,a,t,n),r()})})}static async show_form_dialog(e,a,t,n){return new Promise(r=>{const s=h(e);document.documentElement.appendChild(s.layer),requestAnimationFrame(async()=>{await b(s.widget.id,e.args.html,e.args.url,a,t,n);let c=crsbinding.data.getContext(t.parameters.bId);const o=async m=>{if(m==="pass_step"){let l=await C(`#${s.layer.id} form`);if(l.length>0){t.parameters?.bId!==null&&(e.args.errors=l,await crs.call("binding","set_errors",e.args,a,t,n));return}}delete c.pass,delete c.fail,await this.remove_element({args:{element:`#${s.layer.id}`}});const d=e[m];if(d!=null){const l=crsbinding.utils.getValueOnPath(t.steps,d);l!=null&&await crs.process.runStep(l,a,t,n)}e.args.callback!=null&&e.args.callback(),r()};c.pass=()=>o("pass_step"),c.fail=()=>o("fail_step")})})}static async set_widget(e,a,t,n){const r=e.args.element,s=await E(e,a,t,n),c=await crs.process.getValue(e.args.context,a,t,n)||t?.parameters?.bId;await crsbinding.events.emitter.postMessage(r,{context:c,html:s})}static async clear_widget(e,a,t,n){const r=e.args.element;if(await crsbinding.events.emitter.postMessage(r,{context:null,html:""}),t.bindable==!0){let s=crsbinding.data.getContext(t.parameters.bId);delete s.pass,delete s.fail}}static async move_element(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n),s=await crs.dom.get_element(e.args.target,a,t,n);await f(r,s,e.args.position)}static async move_element_down(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n),s=r.nextElementSibling;s!=null&&await f(r,s,"after")}static async move_element_up(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n),s=r.previousElementSibling;s!=null&&await f(r,s,"before")}static async filter_children(e,a,t,n){const r=await crs.process.getValue(e.args.filter,a,t,n);await v(e.args.element,r)}static async open_tab(e,a,t,n){let r=await crs.call("string","inflate",{template:e.args.url,parameters:e.args.parameters},a,t,n);window.open(r,"_blank")}static async clone_for_movement(e,a,t,n){const r=await crs.dom.get_element(e.args.element,a,t,n),s=await crs.dom.get_element(e.args.parent,a,t,n),c=await crs.process.getValue(e.args.position||{x:0,y:0},a,t,n),o=r.cloneNode(!0),m=Object.keys(e.args.attributes||{}),d=Object.keys(e.args.styles||{}),l=e.args.classes||[];for(let g of m)o.setAttribute(g,await crs.process.getValue(e.args.attributes[g],a,t,n));for(let g of d)o.style[g]=await crs.process.getValue(e.args.styles[g],a,t,n);for(let g of l)o.classList.add(g);return s!=null&&(s.appendChild(o),o.style.position="absolute",o.style.transform=`translate(${c.x}px, ${c.y}px)`),o}static async elements_from_template(e,a,t,n){const r=await crs.process.getValue(e.args.template_id,a,t,n),s=await crs.process.getValue(e.args.template,a,t,n),c=await crs.process.getValue(e.args.data,a,t,n),o=await crs.process.getValue(e.args.remove_template,a,t,n),m=await crs.process.getValue(e.args.recycle,a,t,n),d=await crs.process.getValue(e.args.row_index,a,t,n);let l=await crs.process.getValue(e.args.parent,a,t,n);l=await crs.dom.get_element(l,a,t,n),s!=null&&await p(s,r);let g=null;l!=null&&(m!=!1&&l.childElementCount>0?g=l.children:l.innerHTML="");const u=crsbinding.inflationManager.get(r,c,g,d||0);return u!=null&&l?.appendChild(u),o==!0&&crsbinding.inflationManager.unregister(r),u}static async update_cells(e,a,t,n){return this.elements_from_template(e,a,t,n)}static async create_inflation_template(e,a,t,n){const r=await crs.process.getValue(e.args.template_id,a,t,n),s=await crs.process.getValue(e.args.source,a,t,n),c=await crs.process.getValue(e.args.tag_name,a,t,n),o=await crs.process.getValue(e.args.wrapper,a,t,n),m=await crs.process.getValue(e.args.ctx,a,t,n),d=Object.keys(s),l=document.createElement("template");let g=l;if(o!=null){const u=await this.create_element({args:o},a,t,n);l.content.appendChild(u),g=u}for(let u of d){let w=s[u];w.tag_name=c;let y=await this.create_element({args:w},a,t,n);y.textContent=["${",u,"}"].join(""),g.content!=null?g.content.appendChild(y):g.appendChild(y)}crsbinding.inflationManager.register(r,l,m||"context")}static async get_element_bounds(e,a,t,n){const s=(await crs.dom.get_element(e.args.element,a,t,n)).getBoundingClientRect();return e.args.target!=null&&await crs.process.setValue(e.args.target,s,a,t,n),s}}async function p(i,e,a){let t;i instanceof HTMLTemplateElement?t=i:t=document.querySelector(i),crsbinding.inflationManager.register(e,t)}async function f(i,e,a){if(i==null||e==null)return console.error("both element and parent must exist to move the element");if(i.parentElement.removeChild(i),a==null)return e.appendChild(i);if(a=="before")return e.parentElement.insertBefore(i,e);if(e.nextSibling==null)return e.parentElement.appendChild(i);e.parentElement.insertBefore(i,e.nextSibling)}async function v(i,e){i=await crs.dom.get_element(i);const a=e.length>0;for(let t of i.children)t.removeAttribute("hidden"),t.dataset.tags&&a&&t.dataset.tags.indexOf(e)==-1&&t.setAttribute("hidden","hidden")}async function C(i){const a=document.querySelector(i)?.querySelectorAll("label"),t=[];for(let n of a){const s=n.querySelector("input").validationMessage;s.length>0&&t.push(`${n.children[0].textContent}: ${s}`)}return t}async function E(i,e){if(i.args.url.indexOf("$fn")!=-1){const a=i.args.url.replace("$fn.",""),t=await e[a](i.args),n=document.createElement("template"),r=i.args.html.split(".")[1];return n.innerHTML=t,crsbinding.templates.add(r,n),t}if(i.args.html.indexOf("$template")==0){const a=i.args.html.split(".")[1];return await crsbinding.templates.get(a,i.args.url)}}function h(i){const e=document.createElement("div");e.style.zIndex="99999999",e.style.position="fixed",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.id=i.args.id||"widget_layer";const a=document.createElement("div");a.classList.add("modal-background");const t=document.createElement("crs-widget");return t.style.position="fixed",t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)",t.id=`${e.id}_widget`,e.appendChild(a),e.appendChild(t),{layer:e,widget:t}}async function b(i,e,a,t,n,r){await _.set_widget({args:{element:`#${i}`,html:e,url:a}},t,n,r);const s=document.querySelector(`#${i} [autofocus]`);s!=null?s.focus():document.querySelector(`#${i}`).focus()}crs.intent.dom=_;export{_ as DomActions};
